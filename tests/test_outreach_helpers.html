<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Outreach Helpers Unit Tests</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; }
        .test-case { margin-bottom: 1rem; border: 1px solid #eee; padding: 1rem; }
        .pass { background-color: #e6ffed; }
        .fail { background-color: #ffe6e6; }
        pre { background-color: #f4f4f4; padding: 0.5rem; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>Unit Tests for Outreach Helper Functions</h1>
    <div id="results"></div>

    <!-- The script with the functions to be tested -->
    <script>
        // Mocking the parts of outreach.js that are not needed for these helpers
        document.addEventListener('DOMContentLoaded', () => {});
    </script>
    <script src="../static/js/outreach.js"></script>

    <script>
        const resultsDiv = document.getElementById('results');

        function runTest(name, testFn) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-case';
            let passed = false;
            let error = null;
            let actual, expected;

            try {
                const result = testFn();
                actual = result.actual;
                expected = result.expected;
                passed = JSON.stringify(actual) === JSON.stringify(expected);
            } catch (e) {
                error = e;
            }

            resultDiv.classList.add(passed ? 'pass' : 'fail');
            resultDiv.innerHTML = `
                <h3>${name}: ${passed ? 'PASSED' : 'FAILED'}</h3>
                ${error ? `<p><strong>Error:</strong> ${error.message}</p>` : ''}
                <p><strong>Expected:</strong></p>
                <pre>${JSON.stringify(expected, null, 2)}</pre>
                <p><strong>Actual:</strong></p>
                <pre>${JSON.stringify(actual, null, 2)}</pre>
            `;
            resultsDiv.appendChild(resultDiv);
        }

        // --- Test Cases ---

        runTest('normalizeEmail: should trim and lowercase', () => {
            const email = '  Test.Email@Example.com  ';
            const expected = 'test.email@example.com';
            const actual = normalizeEmail(email);
            return { actual, expected };
        });

        runTest('dedupeByEmail: should remove duplicates based on normalized email', () => {
            const contacts = [
                { id: 1, email: 'test@example.com', name: 'First' },
                { id: 2, email: 'TEST@example.com', name: 'Second' },
                { id: 3, email: 'another@example.com', name: 'Third' },
                { id: 4, email: ' test@example.com ', name: 'Fourth' },
                { id: 5, email: null, name: 'No Email' },
            ];
            const expected = [
                { id: 1, email: 'test@example.com', name: 'First' },
                { id: 3, email: 'another@example.com', name: 'Third' },
            ];
            // The dedupeByEmail function is not globally available, need to call it from within its scope
            // For this test, I will redefine it here. In a real project with modules, this would be imported.
            const dedupeByEmail_test = (arr) => {
                  const seen = new Set();
                  const out = [];
                  for (const x of arr) {
                    const key = normalizeEmail(x.email);
                    if (!key || seen.has(key)) continue;
                    seen.add(key);
                    out.push(x);
                  }
                  return out;
            }
            const actual = dedupeByEmail_test(contacts);
            return { actual, expected };
        });

        runTest('buildPayload: should create the correct payload structure', () => {
            const pressReleaseId = 'pr_123';
            const contacts = [
                { id: 'journalist_1', contactName: 'John Smith', email: 'john@example.com', outletName: 'Test News', categories: ['Tech'] },
                { id: 'media_title_2', contactName: 'Jane Doe', email: 'jane@example.com', outletName: 'Another Paper', categories: [] },
                { id: 'journalist_3', contactName: 'John Smith Duplicate', email: 'john@example.com', outletName: 'Test News', categories: ['Tech'] },
            ];

            const buildPayload_test = (prId, c) => {
              const dedupe = (arr) => {
                  const seen = new Set();
                  const out = [];
                  for (const x of arr) {
                    const key = (x.email || "").trim().toLowerCase();
                    if (!key || seen.has(key)) continue;
                    seen.add(key);
                    out.push(x);
                  }
                  return out;
              }
              const uniq = dedupe(c);
              return {
                pressReleaseId: prId || null,
                selectedContacts: uniq.map(con => ({
                  contactId: String(con.id),
                  contactName: con.contactName || "",
                  email: con.email,
                  outletName: con.outletName || null,
                  categories: Array.isArray(con.categories) && con.categories.length ? con.categories : undefined
                })),
                total: uniq.length
              };
            }

            const expected = {
                pressReleaseId: 'pr_123',
                selectedContacts: [
                    { contactId: 'journalist_1', contactName: 'John Smith', email: 'john@example.com', outletName: 'Test News', categories: ['Tech'] },
                    { contactId: 'media_title_2', contactName: 'Jane Doe', email: 'jane@example.com', outletName: 'Another Paper', categories: undefined },
                ],
                total: 2
            };
            const actual = buildPayload_test(pressReleaseId, contacts);
            return { actual, expected };
        });

    </script>
</body>
</html>
