{% extends "layout.html" %}

{% block title %}Emails - Sway PR Data{% endblock %}
{% block page_title %}Email Management{% endblock %}

{% block content %}
<div class="controls-row">
    <div class="action-control">
        <button id="uploadEmailBtn" class="btn btn-primary btn-add-new">
            <span class="btn-icon">+</span> Upload New Email
        </button>
    </div>
</div>

<div id="uploadEmailModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Upload Email</h3>
            <button id="closeUploadModalBtn" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <form id="uploadEmailForm">
                <div class="form-group">
                    <label for="emailTitle">Title</label>
                    <input type="text" id="emailTitle" name="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="emailFile">Word Document (.docx)</label>
                    <input type="file" id="emailFile" name="file" class="form-control" accept=".docx" required>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" id="cancelUploadBtn" class="btn btn-secondary">Cancel</button>
            <button type="button" id="submitUploadBtn" class="btn btn-primary">Upload</button>
        </div>
    </div>
</div>

<div id="emailsList">
    <p>Loading emails...</p>
</div>

<div id="emailViewModal" class="modal" style="display: none;">
    <div class="modal-content large">
        <div class="modal-header">
            <h3 id="emailViewTitle" class="modal-title"></h3>
            <button id="closeEmailViewModalBtn" class="close-btn">&times;</button>
        </div>
        <div class="modal-body">
            <div id="emailViewContent"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function fetchEmails() {
    const emailsListDiv = document.getElementById('emailsList');
    try {
        const response = await fetch('/api/emails');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const emails = await response.json();
        renderEmails(emails);
    } catch (error) {
        console.error('Error fetching emails:', error);
        emailsListDiv.innerHTML = `<p class="alert alert-danger">Error loading emails. Please try again later.</p>`;
    }
}

function renderEmails(emails) {
    const emailsListDiv = document.getElementById('emailsList');
    if (emails.length === 0) {
        emailsListDiv.innerHTML = '<p>No emails found. Upload one to get started!</p>';
        return;
    }
    let tableHtml = `<div class="companies-table-container"><table class="companies-table"><thead><tr>
                    <th>Title</th><th>Created At</th><th>Updated At</th><th>Actions</th>
                    </tr></thead><tbody>`;
    emails.forEach(email => {
        tableHtml += `<tr>
                <td><a href="#" class="view-email-btn" data-id="${email.id}">${email.title}</a></td>
                <td>${new Date(email.created_at).toLocaleString()}</td>
                <td>${new Date(email.updated_at).toLocaleString()}</td>
                <td class="action-buttons">
                    <a href="/emails/${email.id}/edit" class="btn btn-secondary btn-sm">Edit</a>
                    <button class="btn btn-danger btn-sm delete-email-btn" data-id="${email.id}">Delete</button>
                </td></tr>`;
    });
    tableHtml += '</tbody></table></div>';
    emailsListDiv.innerHTML = tableHtml;

    document.querySelectorAll('.view-email-btn').forEach(button => {
        button.addEventListener('click', async (event) => {
            const emailId = event.target.dataset.id;
            const response = await fetch(`/api/emails/${emailId}`);
            const email = await response.json();
            document.getElementById('emailViewTitle').textContent = email.title;
            document.getElementById('emailViewContent').innerHTML = email.content;
            document.getElementById('emailViewModal').style.display = 'block';
        });
    });

    document.querySelectorAll('.delete-email-btn').forEach(button => {
        button.addEventListener('click', async (event) => {
            const emailId = event.target.dataset.id;
            if (confirm('Are you sure you want to delete this email?')) {
                const response = await fetch(`/api/emails/${emailId}`, { method: 'DELETE' });
                const result = await response.json();
                if (response.ok) {
                    alert(result.message);
                    fetchEmails();
                } else {
                    alert(`Error: ${result.error}`);
                }
            }
        });
    });
}

document.addEventListener('DOMContentLoaded', function() {
    const uploadEmailBtn = document.getElementById('uploadEmailBtn');
    const uploadEmailModal = document.getElementById('uploadEmailModal');
    const closeUploadModalBtn = document.getElementById('closeUploadModalBtn');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const submitUploadBtn = document.getElementById('submitUploadBtn');
    const uploadEmailForm = document.getElementById('uploadEmailForm');
    const emailViewModal = document.getElementById('emailViewModal');
    const closeEmailViewModalBtn = document.getElementById('closeEmailViewModalBtn');

    uploadEmailBtn.addEventListener('click', () => {
        uploadEmailModal.style.display = 'block';
    });

    closeUploadModalBtn.addEventListener('click', () => {
        uploadEmailModal.style.display = 'none';
    });

    cancelUploadBtn.addEventListener('click', () => {
        uploadEmailModal.style.display = 'none';
    });

    submitUploadBtn.addEventListener('click', async () => {
        const formData = new FormData(uploadEmailForm);
        const response = await fetch('/api/emails/upload', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        if (response.ok) {
            alert(result.message);
            uploadEmailModal.style.display = 'none';
            fetchEmails();
        } else {
            alert(`Error: ${result.error}`);
        }
    });

    closeEmailViewModalBtn.addEventListener('click', () => {
        emailViewModal.style.display = 'none';
    });

    fetchEmails();
});
</script>
{% endblock %}
